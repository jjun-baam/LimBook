<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LIM BOOK</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.2/css/bootstrap-slider.min.css"
      integrity="sha256-G3IAYJYIQvZgPksNQDbjvxd/Ca1SfCDFwu2s2lt0oGo="
      crossorigin="anonymous"
    />
    <link rel="stylesheet" type="text/css" href="./css/list.css" />

    <link rel="icon" href="./images/limbook.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="./css/detail.css" />
    <link rel="stylesheet" href="./css/common.css" />
    <link rel="stylesheet" href="./css/main.css" />

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
      integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- GSAP & ScrollToPlugin -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"
      integrity="sha512-H6cPm97FAsgIKmlBA4s774vqoN24V5gSQL4yBTDOY2su2DeXZVhQPxFK4P6GPdnZqM9fg1G3cMv5wD7e6cFLZQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/ScrollToPlugin.min.js"
      integrity="sha512-agNfXmEo6F+qcj3WGryaRvl9X9wLMQORbTt5ACS9YVqzKDMzhRxY+xjgO45HCLm61OwHWR1Oblp4QSw/SGh9SA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- SWIPER -->
    <link rel="stylesheet" href="https://unpkg.com/swiper@6.8.4/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper@6.8.4/swiper-bundle.min.js"></script>

    <!-- ScrollMagic -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.8/ScrollMagic.min.js"
      integrity="sha512-8E3KZoPoZCD+1dgfqhPbejQBnQfBXe8FuwL4z/c8sTrgeDMFEnoyTlH3obB4/fV+6Sg0a0XF+L/6xS4Xx1fUEg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script defer src="./js/youtube.js"></script>
    <script defer src="./js/common.js"></script>
    <script defer src="./js/main.js"></script>
  </head>
  <body>
    <nav class="navbar nav-global fixed-top navbar-expand-sm">
      <div class="container">
        <a class="navbar-brand" href="javascript:history.back()" id="backBtn">
          <i class="material-icons ic-filter">arrow_back_ios</i>뒤로
        </a>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a href="javascript:void(0)" class="btn btn-sm btn-warning disabled" id="chat">채팅으로 거래하기</a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container container-sm container-detail"></div>
    <!-- FOOTER -->
    <footer>
      <div class="inner">
        <ul class="menu">
          <li><a href="javascript:void(0)" class="green">개인정보처리방침</a></li>
          <li><a href="javascript:void(0)">홈페이지 이용약관</a></li>
          <li><a href="javascript:void(0)">광고운영정책</a></li>
          <li><a href="javascript:void(0)">위치정보 이용약관</a></li>
          <li><a href="javascript:void(0)">중고도서정책</a></li>
          <li><a href="javascript:void(0)">윤리경영 핫라인</a></li>
        </ul>

        <div class="btn-group">
          <a href="https://pt.daelim.ac.kr/" target="_blank" class="btn btn--white">학생포털</a>
          <a href="https://lms.daelim.ac.kr/my/index.php" target="_blank" class="btn btn--white">BigFOREST</a>
          <a href="https://daelim.everytime.kr/" target="_blank" class="btn btn--white">에브리타임</a>
        </div>

        <div class="info">
          <span>사업자등록번호 123-45-67890</span>
          <span>(팀)림북 : 김준범 김요환 박주형 이해준 최근우</span>
          <span>TEL : 02) 1234-5678 / FAX : 02) 5678-1234</span>
        </div>

        <p class="copyright">
          &copy; <span class="this-year"></span> Capstone Design Team LimBook. All Rights Reserved.
        </p>
        <img src="../images/limbook_logo_only_text.png" alt="" class="logo" />
      </div>
    </footer>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.2/bootstrap-slider.js"
      integrity="sha256-59/apVFrosMLFX2dHZLGvb3nPpu7e0Yx1rsDr1dTRrk="
      crossorigin="anonymous"
    ></script>

    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>

    <script>
      var firebaseConfig = {
        apiKey: "AIzaSyCB1lvUxpdNZibf7rDKbfPQW4GGHV1jOfU",
        authDomain: "limbook-7cd80.firebaseapp.com",
        projectId: "limbook-7cd80",
        storageBucket: "limbook-7cd80.appspot.com",
        messagingSenderId: "616165931768",
        appId: "1:616165931768:web:3f797ff4a9a8c0c2f8990d",
        measurementId: "G-BDDR0TLJN1",
      };
      //Initailize Firebase
      firebase.initializeApp(firebaseConfig);
    </script>
    <script>
      const db = firebase.firestore();
      const storage = firebase.storage();
      const queryString = new URLSearchParams(window.location.search);
      const 상품id = queryString.get("id");
      let 판매자uid;
      let 상품명;

      db.collection("product")
        .doc(상품id)
        .get()
        .then((result) => {
          판매자uid = result.data().uid;
          상품명 = result.data().title;
          const timeStamp = result.data().date.seconds * 1000;
          const date = new Date(timeStamp);
          const 템플릿 = `
                <div class="description">
                <img src="${result.data().img}" alt="" id="product-img">
                <h3 class="product-title" id="product-title">${result.data().title}</h3>
                <h4 class="product-price" id="product-price">
                    ${result.data().price}원
                </h4>
                <ul class="list-product-information">
                    <li class="list-item category">카테고리 : ${result.data().category}
                    </li>
                    <li class="list-item">작성자 : ${result.data().name}
                    </li>
                    <li class="list-item date">업로드일자 : ${date.getFullYear()}년 ${
            date.getMonth() + 1
          }월 ${date.getDate()}일 ${date.getHours()} : ${date.getMinutes()} : ${date.getSeconds()}
                    </li>
                    <li class="list-item">
                        <h4>
                            내용 : ${result.data().content}
                        </h4>
                    </li>
                </ul>

                </div>`;
          $(".container-detail").append(템플릿);
        });

      $("#chat").click(() => {
        const 내uid = JSON.parse(localStorage.getItem("user")).uid;
        if (내uid == 판매자uid) {
          window.location.href = `/myChat.html?id=${상품id}&id2=${내uid}`;
        } else {
          db.collection("product")
            .doc(상품id)
            .collection("chat-room")
            .where("uid", "==", 내uid)
            .get()
            .then(async (result) => {
              console.log(result);
              if (result.empty) {
                const chatRoom = {
                  uid: 내uid,
                  name: JSON.parse(localStorage.getItem("user")).displayName,
                  date: new Date(),
                };
                await db.collection("product").doc(상품id).collection("chat-room").add(chatRoom);
                console.log("채팅방이 생성되었습니다.");
                window.location.href = `/chat.html?id=${상품id}`;
              } else {
                console.log(result);
                console.log("채팅방이 이미 있습니다.");
                window.location.href = `/chat.html?id=${상품id}`;
              }
            });
        }
      });
    </script>
  </body>
</html>

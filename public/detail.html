<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LIM BOOK</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" type="text/css" href="./css/list.css" />

    <link rel="icon" href="./images/limbook.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="./css/common.css" />
    <link rel="stylesheet" href="./css/main.css" />
    <link rel="stylesheet" href="./css/detail.css" />

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
      integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- GSAP & ScrollToPlugin -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"
      integrity="sha512-H6cPm97FAsgIKmlBA4s774vqoN24V5gSQL4yBTDOY2su2DeXZVhQPxFK4P6GPdnZqM9fg1G3cMv5wD7e6cFLZQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/ScrollToPlugin.min.js"
      integrity="sha512-agNfXmEo6F+qcj3WGryaRvl9X9wLMQORbTt5ACS9YVqzKDMzhRxY+xjgO45HCLm61OwHWR1Oblp4QSw/SGh9SA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- SWIPER -->
    <link rel="stylesheet" href="https://unpkg.com/swiper@6.8.4/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper@6.8.4/swiper-bundle.min.js"></script>

    <!-- ScrollMagic -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.8/ScrollMagic.min.js"
      integrity="sha512-8E3KZoPoZCD+1dgfqhPbejQBnQfBXe8FuwL4z/c8sTrgeDMFEnoyTlH3obB4/fV+6Sg0a0XF+L/6xS4Xx1fUEg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script defer src="./js/youtube.js"></script>
    <script defer src="./js/common.js"></script>
    <script defer src="./js/main.js"></script>

    <script src="/js/includeHTML.js"></script>
  </head>
  <body>
    <nav class="navbar nav-global fixed-top navbar-expand-sm">
      <div class="container">
        <a class="navbar-brand" href="javascript:history.back()">
          <i class="material-icons ic-filter">arrow_back_ios</i>뒤로
        </a>
        <ul class="navbar-nav ml-auto" id="ullist">
          <div class="container container-sm container-detail">
            <button class="btn btn-outline-secondary" id="chat">채팅</button>
          </div>
        </ul>
      </div>
    </nav>

    <div class="container container-sm container-detail"></div>

    <!-- FOOTER -->
    <footer w3-include-html="/footer.html"></footer>

    <!--header footer합치기 -->
    <script>
      includeHTML();
    </script>

    <!-- Firebase Code -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>

    <script type="module" src="/js/firebaseConfig.js"></script>
    <script type="module" src="/js/loginCheck.js"></script>
    <script type="module">
      import { db, storage } from "/js/firebaseConfig.js";

      const queryString = new URLSearchParams(window.location.search);
      const 상품id = queryString.get("id");
      let 판매자uid;
      let 상품명;

      db.collection("product")
        .doc(상품id)
        .get()
        .then((result) => {
          판매자uid = result.data().uid;
          상품명 = result.data().title;
          const timeStamp = result.data().date.seconds * 1000;
          const date = new Date(timeStamp);
          const 템플릿 = `
                <div class="description">
                <img src="${result.data().img}" alt="" id="product-img">
                <h3 class="product-title" id="product-title">${result.data().title}</h3>
                <h4 class="product-price" id="product-price">
                    ${result.data().price}원
                </h4>
                <ul class="list-product-information">
                    <li class="list-item category">카테고리 : ${result.data().category}
                    </li>
                    <li class="list-item date">${date.getFullYear()}년 ${
            date.getMonth() + 1
          }월 ${date.getDate()}일 ${date.getHours()} : ${date.getMinutes()} : ${date.getSeconds()}
                    </li>
                </ul>

                </div>`;
          $("#ullist").append(템플릿);
        });

      $("#chat").click(() => {
        const 내uid = JSON.parse(localStorage.getItem("user"));
        if (내uid == 판매자uid) {
          window.location.href = `/myChat.html?id=${상품id}&id2=${내uid}`;
        } else {
          db.collection("product")
            .doc(상품id)
            .collection("chat-room")
            .where("uid", "==", 내uid)
            .get()
            .then(async (result) => {
              console.log(result);
              if (result.empty) {
                const chatRoom = {
                  uid: 내uid,
                  chatName: 상품명,
                  date: new Date(),
                };
                await db.collection("product").doc(상품id).collection("chat-room").add(chatRoom);
                console.log("채팅방이 생성되었습니다.");
                window.location.href = `/chat.html?id=${상품id}`;
              } else {
                console.log(result);
                console.log("채팅방이 이미 있습니다.");
                window.location.href = `/chat.html?id=${상품id}`;
              }
            });
        }
      });

      /** //채팅 버튼 눌렀을 때 자기자신이랑 같으면 오류 메시지
      //다르면 로직 수행
      $("#chat").click(() => {
        const 내uid = JSON.parse(localStorage.getItem("user"));
        if (내uid == 판매자uid) {
          alert("채팅은 다른사람과 가능합니다.");
        } else {
          db.collection("chatting")
            .where("participant", "in", [내uid, 판매자uid, 상품id]) // 내uid, 판매자uid가 포함된 채팅방이 있는지 확인
            .get()
            .then(async (result) => {
              if (result.empty) {
                console.log(`내UID : ${내uid} 판매자UID : ${판매자uid}`);
                console.log("비어있음");
                console.log(result);
                const 데이터 = {
                  participant: [내uid, 판매자uid, 상품id], //채팅방 참여자
                  product: 상품명,
                  date: new Date(),
                };
                await db.collection("chatting").add(데이터);
                //window.location.href = "/chat.html?id=" + 내uid;
              } else {
                console.log(`내UID : ${내uid} 판매자UID : ${판매자uid}`);
                console.log("있음");
                console.log(result);
                // 비어 있지 않을 때 즉, 값이 있을 때
                //window.location.href = `/chat.html?id=${내uid}`;
              }
            });
        }
      }); **/
    </script>
  </body>
</html>
